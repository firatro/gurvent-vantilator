@{
    ViewData["Title"] = "Test DatasÄ± Detay";
    int productId = ViewBag.ProductId;
}

<div class="row">
    <div class="col">

        <!-- ================= FAN PERFORMANCE CHART ================= -->
        <section class="card card-modern mb-4">
            <div class="card-body">
                <div class="row">

                    <!-- SOL BÄ°LGÄ° -->
                    <div class="col-lg-2-5 col-xl-1-5">
                        <i class="card-big-info-icon bx bx-line-chart"></i>
                        <h2 class="card-big-info-title">Fan Performans EÄŸrisi</h2>
                        <p class="card-big-info-desc">
                            SeÃ§ilen Ã¼rÃ¼ne ait debi (Q) â€“ basÄ±nÃ§ (Pt) performans eÄŸrileri.
                        </p>
                    </div>

                    <!-- CHART -->
                    <div class="col-lg-3-5 col-xl-4-5 p-4">
                        <canvas id="fanChart" height="480"></canvas>
                    </div>

                </div>
            </div>
        </section>


        <!-- ================= META DATA TABLE ================= -->
        <section class="card card-modern mt-4">
            <div class="card-body">
                <h5 class="mb-3">Test Ã–lÃ§Ã¼m DeÄŸerleri</h5>

                <table class="table table-sm table-bordered">
                    <tbody>
                        <tr>
                            <th>Debi (Q)</th>
                            <td id="meta-q">-</td>
                        </tr>
                        <tr>
                            <th>Ps (Pa)</th>
                            <td id="meta-ps">-</td>
                        </tr>
                        <tr>
                            <th>Pd (Pa)</th>
                            <td id="meta-pd">-</td>
                        </tr>
                        <tr>
                            <th>Pt (Pa)</th>
                            <td id="meta-pt">-</td>
                        </tr>
                        <tr>
                            <th>AkÄ±m (A)</th>
                            <td id="meta-current">-</td>
                        </tr>
                        <tr>
                            <th>HÄ±z</th>
                            <td id="meta-speed">-</td>
                        </tr>
                        <tr>
                            <th>Hava GÃ¼cÃ¼</th>
                            <td id="meta-airpower">-</td>
                        </tr>
                        <tr>
                            <th>Toplam Verim (%)</th>
                            <td id="meta-total-eff">-</td>
                        </tr>
                        <tr>
                            <th>Mekanik Verim (%)</th>
                            <td id="meta-mech-eff">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <!-- ================= WORKING POINT ================= -->
        <section class="card card-modern">
            <div class="card-body">
                <div class="row">

                    <!-- SOL BÄ°LGÄ° -->
                    <div class="col-lg-2-5 col-xl-1-5">
                        <i class="card-big-info-icon bx bx-target-lock"></i>
                        <h2 class="card-big-info-title">Ã‡alÄ±ÅŸma NoktasÄ±</h2>
                        <p class="card-big-info-desc">
                            Ä°stenen debi ve basÄ±nÃ§ deÄŸerine gÃ¶re
                            en yakÄ±n Ã§alÄ±ÅŸma noktasÄ± hesaplanÄ±r.
                        </p>
                    </div>

                    <!-- FORM -->
                    <div class="col-lg-3-5 col-xl-4-5">
                        <form id="workingPointForm" asp-action="CalculateWorkingPoint" method="post">

                            <input type="hidden" name="ProductId" value="@productId" />

                            <div class="row">

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Debi (Q)</label>
                                    <input name="Q" class="form-control form-control-modern" placeholder="Ã–rn: 12.5" />
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">BasÄ±nÃ§ (Pt)</label>
                                    <input name="Pt" class="form-control form-control-modern" placeholder="Ã–rn: 850" />
                                </div>

                                <div class="col-md-4 d-flex align-items-end mb-3">
                                    <button class="btn btn-success btn-px-4 py-3 w-100">
                                        <i class="bx bx-calculator me-1"></i>
                                        Hesapla
                                    </button>
                                </div>

                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </section>


    </div>
</div>

@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let fanChartInstance = null;
    </script>

    <script>
        fetch('/FanChart/GetChart?productId=@productId')
            .then(res => res.json())
            .then(chart => {

                // ===== META TABLOYU DOLDUR =====
                if (chart.meta) {
                    setMeta(chart.meta);
                }

                const ctx = document.getElementById('fanChart').getContext('2d');

                fanChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: chart.datasets.map(d => ({
                            label: d.label,
                            data: d.data,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        parsing: false,

                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: chart.xAxisLabel
                                },
                                ticks: {
                                    stepSize: 250
                                },
                                grid: {
                                    color: '#eee'
                                }
                            },
                            y: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: chart.yAxisLabel
                                },
                                ticks: {
                                    stepSize: 100
                                },
                                grid: {
                                    color: '#eee'
                                }
                            }
                        },

                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function () {
                                        return null;
                                    },
                                    label: function (ctx) {
                                        const p = ctx.raw;

                                        // ðŸ”¥ hover'da tabloyu gÃ¼ncelle
                                        updateMetaFromPoint(p);

                                        return [
                                            `Q: ${p.x.toFixed(2)}`,
                                            `Pt: ${p.y.toFixed(2)}`
                                        ];
                                    }
                                }
                            }
                        },

                        elements: {
                            line: {
                                borderWidth: 2
                            }
                        }
                    }

                });
            });

        // ================= HELPERS =================

        function setMeta(m) {
            setText('meta-ps', m.ps);
            setText('meta-pd', m.pd);
            setText('meta-current', m.current);
            setText('meta-pt', m.pt);
            setText('meta-speed', m.speed);
            setText('meta-airpower', m.airPower);
            setText('meta-total-eff', m.totalEfficiency);
            setText('meta-mech-eff', m.mechanicalEfficiency);
        }

        function updateMetaFromPoint(p) {
            setText('meta-q', p.x);
            setText('meta-ps', p.ps);
            setText('meta-pd', p.pd);
            setText('meta-pt', p.y);          // Pt = Y
            setText('meta-current', p.current);
            setText('meta-speed', p.speed);
            setText('meta-airpower', p.airPower);
            setText('meta-total-eff', p.totalEfficiency);
            setText('meta-mech-eff', p.mechanicalEfficiency);
        }


        function setText(id, val) {
            document.getElementById(id).innerText =
                val !== null && val !== undefined ? val.toFixed(2) : '-';
        }

        document.getElementById('workingPointForm')
            .addEventListener('submit', function (e) {
                e.preventDefault();

                const q = parseFloat(this.querySelector('[name="Q"]').value);
                const pt = parseFloat(this.querySelector('[name="Pt"]').value);

                if (isNaN(q) || isNaN(pt)) {
                    alert('LÃ¼tfen geÃ§erli Q ve Pt giriniz.');
                    return;
                }

                highlightWorkingPoint(q, pt);
            });

        function highlightWorkingPoint(inputQ, inputPt) {

            let minDistance = Infinity;
            let closestDatasetIndex = -1;

            // ================================
            // 1ï¸âƒ£ En yakÄ±n eÄŸriyi bul
            // ================================
            fanChartInstance.data.datasets.forEach((dataset, dsIndex) => {

                dataset.data.forEach(p => {
                    const d = Math.sqrt(
                        Math.pow(p.x - inputQ, 2) +
                        Math.pow(p.y - inputPt, 2)
                    );

                    if (d < minDistance) {
                        minDistance = d;
                        closestDatasetIndex = dsIndex;
                    }
                });
            });

            // ================================
            // 2ï¸âƒ£ Dataset stillerini gÃ¼ncelle
            // ================================
            fanChartInstance.data.datasets.forEach((dataset, index) => {

                if (index === closestDatasetIndex) {
                    dataset.borderWidth = 5;
                    dataset.borderColor = '#0d6efd';
                    dataset.borderDash = [];
                } else {
                    dataset.borderWidth = 1;
                    dataset.borderColor = '#ccc';
                    dataset.borderDash = [5, 5];
                }
            });

            // ================================
            // 3ï¸âƒ£ Ã‡alÄ±ÅŸma noktasÄ± (kÄ±rmÄ±zÄ± nokta)
            // ================================
            const workingPointDatasetIndex =
                fanChartInstance.data.datasets.findIndex(d => d.label === 'Ã‡alÄ±ÅŸma NoktasÄ±');

            if (workingPointDatasetIndex !== -1) {
                fanChartInstance.data.datasets.splice(workingPointDatasetIndex, 1);
            }

            fanChartInstance.data.datasets.push({
                label: 'Ã‡alÄ±ÅŸma NoktasÄ±',
                data: [{ x: inputQ, y: inputPt }],
                borderColor: 'red',
                backgroundColor: 'red',
                pointRadius: 7,
                pointHoverRadius: 9,
                showLine: false
            });

            fanChartInstance.update();
        }


    </script>


}