@model ProductPageViewModel
@{
    ViewData["Title"] = "Fan Seçici";
}
<style>
.custom-range {
    height: 8px;
    border-radius: 5px;
    background: linear-gradient(
        to right,
        #296299 0%,
        #296299 10%,
        #296299 10%,
        #296299 100%
    );
}

.custom-range::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    background: #296299;
    border-radius: 50%;
    cursor: pointer;
}

.custom-range::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: #296299;
    border-radius: 50%;
    cursor: pointer;
}
</style>

<h1 class="text-center" style="color:#296299; margin-top:20px;">
    Kategoriler
</h1>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-warning text-center">@Model.ErrorMessage</div>
}

<div class="postbox-area it-blog-style-2 pt-130 pb-130">
    <div class="container">

    <div class="d-flex justify-content-center mb-4">
        <div class="btn-group bg-light rounded-pill p-1">

            <!-- Kategori -->
            <a href="@Url.Action("Index", "FanSelector", new {
                    mode = "category",
                    usageId = Model.SelectedUsageId,
                    workingId = Model.SelectedWorkingId,
                    seriesId = Model.SelectedSeriesId,
                    modelId = Model.SelectedModelId
                })"
            class="btn rounded-pill @((Model.ViewMode == "category") ? "text-white" : "btn-light")"
            style="@(Model.ViewMode == "category" ? "background-color:#296299;" : "")">
                Katalog Görünümü
            </a>

            <!-- Parametre -->
            <a href="@Url.Action("Index", "FanSelector", new {
                    mode = "parameter",
                    usageId = Model.SelectedUsageId,
                    workingId = Model.SelectedWorkingId,
                    seriesId = Model.SelectedSeriesId,
                    modelId = Model.SelectedModelId
                })"
            class="btn rounded-pill @((Model.ViewMode == "parameter") ? "text-white" : "btn-light")"
            style="@(Model.ViewMode == "parameter" ? "background-color:#296299;" : "")">
                Performansa Göre
            </a>

            <!-- SIFIRLA -->
            <a href="@Url.Action("Index", "FanSelector")"
            class="btn btn-outline-danger rounded-pill ms-1">
                <i class="fa-solid fa-rotate-left me-1"></i>
                Sıfırla
            </a>

        </div>
    </div>

  <div class="d-flex justify-content-between align-items-center mb-3">

    @* === GERİ BUTONU === *@
    @if (Model.HasModel)
    {
        <!-- Ürün → Model -->
        <a href="@Url.Action("Index","FanSelector", new {
                usageId = Model.SelectedUsageId,
                workingId = Model.SelectedWorkingId,
                seriesId = Model.SelectedSeriesId,
                mode = Model.ViewMode
            })"
           class="btn btn-outline-secondary rounded-pill">
            <i class="fa fa-arrow-left me-1"></i> Modellere Dön
        </a>
    }
    else if (Model.HasSeries)
    {
        <!-- Model → Seri -->
        <a href="@Url.Action("Index","FanSelector", new {
                usageId = Model.SelectedUsageId,
                workingId = Model.SelectedWorkingId,
                mode = Model.ViewMode
            })"
           class="btn btn-outline-secondary rounded-pill">
            <i class="fa fa-arrow-left me-1"></i> Serilere Dön
        </a>
    }
    else if (Model.HasUsageOrWorking)
    {
        <!-- Seri → Menü -->
        <a href="@Url.Action("Index","FanSelector", new {
                mode = Model.ViewMode
            })"
           class="btn btn-outline-secondary rounded-pill">
            <i class="fa fa-arrow-left me-1"></i> Kategorilere Dön
        </a>
    }
</div>
<nav class="mb-4 text-muted small">
    <span>Kategoriler</span>

    @if (Model.HasUsageOrWorking)
    {
        <span> / Seri</span>
    }
    @if (Model.HasSeries)
    {
        <span> / Model</span>
    }
    @if (Model.HasModel)
    {
        <span> / Ürün</span>
    }
</nav>




        @if (Model.ViewMode == "category")
        {
            <div class="row gx-35">

                <!-- LEFT SIDEBAR -->
                <div class="col-xl-4 col-lg-4">
                    <div class="sidebar-left">

                        <!-- ÇALIŞMA ORTAMI -->
                        <div class="sidebar-widget mb-30" id="working-section">
                            <h4 class="sidebar-widget-title mb-25">Çalışma Ortamı</h4>


                            @foreach (var wc in Model.WorkingConditions)
                            {
                                <a class="working-item"
                                    href="@Url.Action("Index", new {
                                        usageId = Model.SelectedUsageId,
                                        workingId = wc.Id,
                                        mode = "category",
                                        scroll = "usage"
                                    })">

                                    <div class="sidebar-widget-list mb-15">
                                        @wc.Name
                                        <span>
                                            <svg width="12" height="12">
                                                <path d="M10.0035 3.40804L1.41153 12L0 10.5885L8.59097 1.99651H1.01922V0H12V10.9808H10.0035V3.40804Z"
                                                    fill="currentcolor" />
                                            </svg>
                                        </span>
                                    </div>
                                </a>
                            }
                        </div>

                        <!-- KULLANIM ALANI -->
                        <div class="sidebar-widget mb-30" id="usage-section">
                            <h4 class="sidebar-widget-title mb-25">Kullanım Alanı</h4>


                            @foreach (var ut in Model.UsageTypes)
                            {
                                <a class="category-item"
                                    href="@Url.Action("Index", new {
                                        usageId = ut.Id,
                                        workingId = Model.SelectedWorkingId,
                                        mode = "category",
                                        scroll = "results"
                                    })">


                                    <div class="sidebar-widget-list mb-15">
                                        @ut.Name
                                        <span>
                                            <svg width="12" height="12">
                                                <path d="M10.0035 3.40804L1.41153 12L0 10.5885L8.59097 1.99651H1.01922V0H12V10.9808H10.0035V3.40804Z"
                                                    fill="currentcolor" />
                                            </svg>
                                        </span>
                                    </div>
                                </a>
                            }
                        </div>

                    </div>
                </div>



                <!-- RIGHT CONTENT -->
                <div class="col-xl-8 col-lg-8">
                    <div id="seriesContainer">

                        @* 1) SERİ SEÇİLMEDİ — SERİLERİ GÖSTER *@
                        @if (!Model.SelectedSeriesId.HasValue)
                        {
                            @await Html.PartialAsync("_SeriesList", new SeriesListViewModel {
                                Series = Model.Series,
                                SelectedUsageId = Model.SelectedUsageId,
                                SelectedWorkingId = Model.SelectedWorkingId
                            })
                        }

                        @* 2) SERİ SEÇİLDİ AMA MODEL SEÇİLMEDİ — MODELLERİ GÖSTER *@
                        else if (Model.SelectedSeriesId.HasValue && !Model.SelectedModelId.HasValue)
                        {
                            @await Html.PartialAsync("_ModelList", new ModelListViewModel {
                                Models = Model.Models,
                                SelectedSeriesId = Model.SelectedSeriesId,
                                SelectedSeriesName = Model.SelectedSeriesName,
                                SelectedUsageId = Model.SelectedUsageId,
                                SelectedWorkingId = Model.SelectedWorkingId
                            })
                        }

                        @* 3) MODEL SEÇİLDİ — ÜRÜNLERİ GÖSTER *@
                        else if (Model.SelectedModelId.HasValue)
                        {
                            <h3>@Model.SelectedModelName Ürünleri</h3>
                            @await Html.PartialAsync("_ProductList", Model.Products)
                        }

                    </div>
                </div>


            </div>
        }
        @if (Model.ViewMode == "parameter")
{
    <!-- PARAMETRE ARAMA EKRANI + SONUÇLAR YAN YANA -->
    <section class="checkout-area pb-70 pt-50">
        <div class="container">
            <div class="row">

                <!-- SOL: PARAMETRE FORMU -->
                <div class="col-lg-6">
                    <div class="checkbox-form">
                        <h3>Fan Parametre Seçimi</h3>

                        <form id="fanParamForm">
                            <div class="row">

                                <!-- AirFlow -->
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Debi (AirFlow)</label>
                                        <input type="number" name="AirFlow" placeholder="Örn: 5000">
                                    </div>
                                </div>

                                <!-- AirFlowUnit -->
                                <div class="col-md-6">
                                    <div class="country-select">
                                        <label>Debi Birimi (AirFlowUnit)</label>
                                        <select name="AirFlowUnit">
                                            @* <option value="">Seçiniz</option> *@
                                            <option value="m3/h">m³/h</option>
                                            @* <option value="m3/s">m³/s</option>
                                            <option value="cfm">cfm</option> *@
                                        </select>
                                    </div>
                                </div>

                                <!-- TotalPressure -->
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Toplam Basınç (TotalPressure)</label>
                                        <input type="number" name="TotalPressure" placeholder="Örn: 300">
                                    </div>
                                </div>

                                <!-- TotalPressureUnit -->
                                <div class="col-md-6">
                                    <div class="country-select">
                                        <label>Basınç Birimi (TotalPressureUnit)</label>
                                        <select name="TotalPressureUnit">
                                            @* <option value="">Seçiniz</option> *@
                                            <option value="Pa">Pa</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Temperature -->
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Sıcaklık (Temperature)</label>
                                        <input type="number" name="Temperature" placeholder="Örn: 50" disabled="true">
                                    </div>
                                </div>

                                <!-- SpeedControl -->
                                <div class="col-md-6">
                                    <div class="country-select">
                                        <label>Sürüş Biçimi</label>
                                         <select name="SpeedControl">
                                            <option value="">Hepsi</option>
                                            <option value="DirectCoupled">Direkt Akuple</option>
                                            <option value="FrequencyDriver">Sürücüyle</option>
                                            @* <option value="Pneumatic">Pnömatik</option> *@
                                        </select>
                                    </div>
                                </div>

                                <!-- Usage -->
                                <div class="col-md-6">
                                    <div class="country-select">
                                        <label>Kullanım Alanı</label>
                                        <select name="UsageId">
                                            <option value="">Seçiniz</option>
                                            @foreach (var u in Model.UsageTypes)
                                            {
                                                <option value="@u.Id">@u.Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <!-- Working -->
                                <div class="col-md-6">
                                    <div class="country-select">
                                        <label>Çalışma Koşulu</label>
                                        <select name="WorkingId">
                                            <option value="">Seçiniz</option>
                                            @foreach (var w in Model.WorkingConditions)
                                            {
                                                <option value="@w.Id">@w.Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <!-- Tolerans -->
                                <div class="col-md-12">
                                    <div class="checkout-form-list">
                                        <label>
                                            Tolerans (%)
                                        </label>
                                        <div class="d-flex align-items-center gap-3">
                                            <!-- Range -->
                                            <div class="flex-fill position-relative">
                                                <input
                                                    type="range"
                                                    class="form-range custom-range"
                                                    id="toleransRange"
                                                    min="0"
                                                    max="100"
                                                    step="1"
                                                    value="10">
                                            </div>
                                            <!-- Number Input -->
                                            <div style="width: 100px;">
                                                <div class="input-group">
                                                    <input
                                                        type="number"
                                                        id="toleransInput"
                                                        name="Tolerans"
                                                        min="0"
                                                        max="100"
                                                        value="10">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Submit Button -->
                                <div class="order-button-payment mt-20">
                                    <button class="it-btn-orange d-flex justify-content-center align-items-center" type="submit">
                                        <span>
                                            <span class="text-1">FANLARI GETİR</span>
                                            <span class="text-2">FANLARI GETİR</span>
                                        </span>
                                    </button>
                                </div>

                            </div>
                        </form>

                    </div>
                </div>

                <!-- SAĞ: ARAMA SONUÇLARI -->
                <div class="col-lg-6">
                    <div class="your-order mb-30">
                        <h3>Fan Arama Sonuçları</h3>

                        <div class="your-order-table table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="text-start"><strong>Ürün</strong></th>
                                        <th class="text-center"><strong>Debi (m³/h)</strong></th>
                                        <th class="text-center"><strong>Basınç (Pa)</strong></th>
                                        <th class="text-center"><strong>Devir (RPM)</strong></th>
                                        <th class="text-center"><strong>Güç (kW)</strong></th>
                                        <th class="text-center"><strong>Ses (dB)</strong></th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">

                                    <!-- ÜRÜNLER AJAX İLE GELECEK -->
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Henüz filtreleme yapılmadı.</td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </section>
}


    </div>
</div>

@section Scripts {

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // Sadece mobil ve tablet
        if (window.innerWidth > 991) return;

        const params = new URLSearchParams(window.location.search);
        const scrollTarget = params.get("scroll");

        let target = null;
        let yOffset = 0;

        if (scrollTarget === "usage") {
            target = document.getElementById("usage-section");
            yOffset = -50; // Kullanım Alanı hizası
        }

        if (scrollTarget === "results") {
            target = document.getElementById("seriesContainer");
            yOffset = -100; // Sonuçlar biraz yukarıdan başlasın
        }

        if (target) {
            setTimeout(() => {
                const y =
                    target.getBoundingClientRect().top +
                    window.pageYOffset +
                    yOffset;

                window.scrollTo({
                    top: y,
                    behavior: "smooth"
                });
            }, 300);
        }
    });
</script>



<script>
    // MODE SWITCH
    document.querySelectorAll(".switch-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            let mode = this.dataset.mode;

            window.location.href =
                `@Url.Action("Index","FanSelector")?mode=${mode}`
                + "&usageId=@Model.SelectedUsageId"
                + "&workingId=@Model.SelectedWorkingId"
                + "&seriesId=@Model.SelectedSeriesId"
                + "&modelId=@Model.SelectedModelId";
        });
    });
</script>

<script>
    document.getElementById("fanParamForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('@Url.Action("SearchFans", "FanSelector")', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {

            const tbody = document.getElementById("resultsBody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Uygun fan bulunamadı
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(p => {
                tbody.innerHTML += `
                    <tr class="result-row" data-product-id="${p.productId}" style="cursor:pointer;">
                        <td class="text-start">${p.productName}</td>
                        <td class="text-center">${p.airFlow ?? "-"}</td>
                        <td class="text-center">${p.totalPressure ?? "-"}</td>
                        <td class="text-center">${p.rpm ?? "-"}</td>
                        <td class="text-center">${p.power ?? "-"}</td>
                        <td class="text-center">${p.sound ?? "-"}</td>
                    </tr>`;
            });

                document.getElementById("resultsBody").addEventListener("click", function (e) {
                    const row = e.target.closest("tr[data-product-id]");
                    if (!row) return;

                    const productId = row.getAttribute("data-product-id");

                    // 1️⃣ Route ile (önerilen)
                    window.location.href = `/Product/Performance/${productId}`;

                    // 2️⃣ Eğer query string kullanıyorsan (alternatif)
                    // window.location.href = `/Product/Performance?id=${productId}`;
                });


        });
    });
</script>
<script>
    const range = document.getElementById("toleransRange");
    const input = document.getElementById("toleransInput");

    function updateUI(value) {
        value = Math.min(100, Math.max(0, value));

        range.value = value;
        input.value = value;

        const percent = (value / 100) * 100;

        range.style.background = `
            linear-gradient(
                to right,
                #0d6efd 0%,
                #0d6efd ${percent}%,
                #dee2e6 ${percent}%,
                #dee2e6 100%
            )
        `;
    }

    // Slider → Input
    range.addEventListener("input", () => {
        updateUI(range.value);
    });

    // Input → Slider
    input.addEventListener("input", () => {
        updateUI(input.value);
    });

    // İlk yükleme
    updateUI(range.value);
</script>

<script>
    const range = document.getElementById("toleransRange");
    const input = document.getElementById("toleransInput");

    // Range → Number
    range.addEventListener("input", () => {
        input.value = range.value;
    });

    // Number → Range
    input.addEventListener("input", () => {
        let val = Math.max(0, Math.min(100, input.value));
        input.value = val;
        range.value = val;
    });
</script>

}
