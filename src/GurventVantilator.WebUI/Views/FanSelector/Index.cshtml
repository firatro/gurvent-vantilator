@using GurventVantilator.Application.DTOs
@{
    ViewData["Title"] = "Fan Se√ßim Sihirbazƒ±";
}

<style>
    #fanChartContainer {
        width: 100%;
        height: 420px;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #fanChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }
</style>



<!-- breadcrumb-area-start -->
<div class="it-breadcrumb-area it-breadcrumb-overlay z-index-1 fix p-relative"
    data-background="~/img/breadcrumb/breadcrumb.jpg">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-xl-8 col-lg-8 col-md-7">
                <div class="it-breadcrumb-content">
                    <div class="it-breadcrumb-title-box">
                        <h3 class="it-breadcrumb-title it-split-text it-split-in-right">Fan Se√ßim Sihirbazƒ±</h3>
                    </div>
                    <div class="it-breadcrumb-list-wrap">
                        <div class="it-breadcrumb-list">
                            <span><a href="/">Ana Sayfa</a></span>
                            <span class="dvdr">
                                <svg width="6" height="9" viewBox="0 0 6 9" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M0.728891 0L0 0.728893L3.76852 4.5L0 8.27111L0.728891 9L5.23148 4.5L0.728891 0Z"
                                        fill="#E03B3B" />
                                </svg>
                            </span>
                            <span><a href="#">Fan Se√ßim Sihirbazƒ±</a></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-4 col-md-5 text-end">
                <img src="~/img/hero/favicon.png" alt="favicon" width="48" />
            </div>
        </div>
    </div>
</div>
<!-- breadcrumb-area-end -->


<!-- fan-selector-area-start -->
<div class="it-cost-calculator-area pt-125 pb-130">
    <div class="container">

        <div class="text-center mb-70">
            <span class="it-section-subtitle">Fan √ñzelliklerini Se√ßin</span>
            <h4 class="it-section-title mb-0">Fan Se√ßim Sihirbazƒ±</h4>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="it-cost-calculator-wrap p-4 rounded">

                    <!-- Application -->
                    <div class="it-cost-calculator-input-box mb-35">
                        <label>Uygulama Alanƒ±</label>
                        <div class="postbox__select">
                            <select id="applicationSelect">
                                <option value="">Hepsi</option>
                                @foreach (var app in (IEnumerable<ProductApplicationDto>)ViewBag.Applications)
                                {
                                    <option value="@app.Id">@app.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="it-cost-calculator-input-box mb-35">
                        <label>√úr√ºn Kategorisi</label>
                        <div class="postbox__select">
                            <select id="categorySelect">
                                <option value="">Hepsi</option>
                                @foreach (var cat in (IEnumerable<ProductCategoryDto>)ViewBag.Categories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Air Flow -->
                    <div class="it-cost-calculator-input-box mb-35">
                        <label>Hava Akƒ±≈üƒ±</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="airFlowInput" placeholder="Deƒüer giriniz">
                            <div class="postbox__select">
                                <select id="airFlowUnit">
                                    <option value="m¬≥/h">m¬≥/h</option>
                                    <option value="m¬≥/s">m¬≥/s</option>
                                    <option value="L/s">L/s</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pressure -->
                    <div class="it-cost-calculator-input-box mb-35">
                        <label> Basƒ±n√ß</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="pressureInput" placeholder="Basƒ±n√ß deƒüerini giriniz">
                            <div class="postbox__select">
                                <select id="pressureUnit">
                                    <option value="Pa">Pa</option>
                                    <option value="mmH‚ÇÇO">mmH‚ÇÇO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tolerans (%) -->
                    <div class="it-cost-calculator-input-box mb-35">
                        <label>Tolerans (%)</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="toleranceInput" placeholder="√ñrn. 10" value="10" min="0" max="100"
                                step="1">
                        </div>
                    </div>


                    <button id="performanceToggle" class="it-btn-orange bg-secondary w-100 mb-35"
                        style="display: flex; align-items: center; justify-content: space-between;">
                        <span>
                            <span class="text-1">PERFORMANS PARAMETRELERƒ∞</span>
                            <span class="text-2">PERFORMANS PARAMETRELERƒ∞</span>
                        </span>
                        <span id="performanceIcon" style="transition: transform 0.3s;">&#9660;</span>
                    </button>

                    <!-- Performans Parametreleri ƒ∞√ßeriƒüi -->
                    <div id="performanceParameters" style="display: none; transition: all 0.3s ease;">

                        <!-- Diameter -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>√áap (Diameter)</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="diameterInput" placeholder="Deƒüer giriniz">
                                <div class="postbox__select">
                                    <select id="diameterUnit">
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="inch">inch</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Power -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>Motor G√ºc√º</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="powerInput" placeholder="Deƒüer giriniz">
                                <div class="postbox__select">
                                    <select id="powerUnit">
                                        <option value="W">W</option>
                                        <option value="kW">kW</option>
                                        <option value="HP">HP</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Voltage -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>Gerilim (Voltage)</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="voltageInput" placeholder="Volt cinsinden giriniz">
                                <div class="postbox__select">
                                    <select id="voltageUnit">
                                        <option value="V">V</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Speed -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>D√∂n√º≈ü Hƒ±zƒ± (Speed)</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="speedInput" placeholder="rpm">
                                <div class="postbox__select">
                                    <select id="speedUnit">
                                        <option value="rpm">rpm</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Noise Level -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>Ses Seviyesi (Noise Level)</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="noiseInput" placeholder="dB(A)">
                            </div>
                        </div>

                        <!-- Frequency -->
                        <div class="it-cost-calculator-input-box mb-35">
                            <label>Frekans</label>
                            <div class="postbox__select">
                                <select id="frequencySelect">
                                    <option value="">Hepsi</option>
                                    <option value="50">50 Hz</option>
                                    <option value="60">60 Hz</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- Button -->
                    <div class="text-center">
                        <button id="fanSelectorBtn" class="it-btn-orange w-100 mb-35">
                            <span>
                                <span class="text-1">Uygun Fanlarƒ± Bul</span>
                                <span class="text-2">Uygun Fanlarƒ± Bul</span>
                            </span>
                            <i>
                                <svg width="12" height="13" viewBox="0 0 12 13" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M10.0035 3.90804L1.41153 12.5L0 11.0885L8.59097 2.49651H1.01922V0.5H12V11.4808H10.0035V3.90804Z"
                                        fill="white" />
                                </svg>
                            </i>
                        </button>
                    </div>

                    <div class="col-12 text-center container-fluid">
                        <div id="fanChartContainer" class="mt-5" style="display:none;">
                            <canvas id="fanChart"></canvas>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="fan-results mt-5"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- fan-selector-area-end -->



@section Scripts {

    <!-- Toggle Script -->
    <script>
        document.getElementById("performanceToggle").addEventListener("click", function () {
            const content = document.getElementById("performanceParameters");
            const icon = document.getElementById("performanceIcon");
            const isHidden = content.style.display === "none" || content.style.display === "";
            content.style.display = isHidden ? "block" : "none";
            icon.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
        });

    </script>


    <script>
        Chart.register(window['chartjs-plugin-annotation']);

        const fanChartContainer = document.getElementById("fanChartContainer");
        const fanCanvas = document.getElementById("fanChart");
        let fanChart = null;

        // üîπ GRAFƒ∞ƒûƒ∞ √áƒ∞Z
        function drawFanChart(curves, workingPoint = null) {
            fanChartContainer.style.display = "block";
            fanCanvas.width = fanChartContainer.clientWidth;
            fanCanvas.height = 420;

            if (fanChart) fanChart.destroy();

            const ctx = fanCanvas.getContext('2d');
            const datasets = curves.map(curve => {
                const color = "#0d2c6b";
                const gradient = ctx.createLinearGradient(0, 0, 0, fanCanvas.height);
                gradient.addColorStop(0, Chart.helpers.color(color).alpha(0.25).rgbString());
                gradient.addColorStop(0, Chart.helpers.color(color).alpha(0.25).rgbString());

                return {
                    label: curve.productName,
                    data: curve.points.map(p => ({ x: p.q, y: p.pt })),
                    borderColor: color,
                    backgroundColor: gradient,
                    tension: 0,
                    fill: false, // üëà ba≈ülangƒ±√ßta kapalƒ±
                    pointRadius: 0,
                    borderWidth: 1
                };
            });

            fanChart = new Chart(fanCanvas, {
                type: "line",
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: "linear",
                            title: { display: true, text: "Hava Akƒ±≈üƒ± (m¬≥/h)" },
                            grid: { color: "#eee" }
                        },
                        y: {
                            title: { display: true, text: "Basƒ±n√ß (Pa)" },
                            grid: { color: "#eee" }
                        }
                    },
                    plugins: {
                        legend: { position: "bottom" },
                        annotation: {
                            annotations: {
                                // üî∏ Working Point (Nokta)
                                wpDot: {
                                    type: "point",
                                    display: workingPoint && workingPoint.x && workingPoint.y,
                                    xValue: workingPoint?.x || 0,
                                    yValue: workingPoint?.y || 0,
                                    backgroundColor: "#0d2c6b",
                                    borderColor: "#fff",
                                    borderWidth: 0.5,
                                    radius: 6
                                },
                                // üî∏ Working Point Etiketi
                                wpLabel: {
                                    type: "label",
                                    display: workingPoint && workingPoint.x && workingPoint.y,
                                    xValue: workingPoint?.x || 0,
                                    yValue: workingPoint?.y || 0,
                                    xAdjust: 30,
                                    yAdjust: -20,
                                    content: workingPoint
                                        ? [`Working Point (${workingPoint.x}, ${workingPoint.y})`]
                                        : [],
                                    font: { size: 12, style: "italic" },
                                    color: "#0d2c6b"
                                },
                                // üî∏ Crosshair (dikey ve yatay √ßizgiler)
                                crossX: {
                                    type: "line",
                                    xMin: 0,
                                    xMax: 0,
                                    borderColor: "rgba(255,99,132,0.4)",
                                    borderWidth: 1,
                                    display: false
                                },
                                crossY: {
                                    type: "line",
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: "rgba(255,99,132,0.4)",
                                    borderWidth: 1,
                                    display: false
                                }
                            }
                        }
                    },
                    interaction: { mode: "nearest", intersect: false }
                }
            });

            // üîπ Tooltip etiketi
            const hoverLabel = document.createElement("div");
            hoverLabel.style.position = "absolute";
            hoverLabel.style.background = "rgba(0,0,0,0.75)";
            hoverLabel.style.color = "#fff";
            hoverLabel.style.fontSize = "12px";
            hoverLabel.style.padding = "4px 6px";
            hoverLabel.style.borderRadius = "4px";
            hoverLabel.style.pointerEvents = "none";
            hoverLabel.style.display = "none";
            hoverLabel.style.transition = "opacity 0.1s ease";
            fanChartContainer.appendChild(hoverLabel);

            // üîπ Mouse hareketiyle anlƒ±k deƒüerleri g√∂ster
            fanCanvas.addEventListener("mousemove", (event) => {
                const chartArea = fanChart.chartArea;
                const xScale = fanChart.scales.x;
                const yScale = fanChart.scales.y;
                const rect = fanCanvas.getBoundingClientRect();

                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;

                // Eksen dƒ±≈üƒ±na √ßƒ±karsa gizle
                if (
                    mouseX < chartArea.left ||
                    mouseX > chartArea.right ||
                    mouseY < chartArea.top ||
                    mouseY > chartArea.bottom
                ) {
                    hoverLabel.style.display = "none";
                    fanChart.options.plugins.annotation.annotations.crossX.display = false;
                    fanChart.options.plugins.annotation.annotations.crossY.display = false;
                    fanChart.update("none");
                    return;
                }

                const xValue = xScale.getValueForPixel(mouseX).toFixed(0);
                const yValue = yScale.getValueForPixel(mouseY).toFixed(0);

                // üî∏ Etiketi g√∂ster
                hoverLabel.textContent = `Hava Akƒ±≈üƒ±: ${xValue} m¬≥/h | Basƒ±n√ß: ${yValue} Pa`;
                hoverLabel.style.left = `${mouseX + 20}px`;
                hoverLabel.style.top = `${mouseY + 20}px`;
                hoverLabel.style.display = "block";
                hoverLabel.style.opacity = "1";

                // üî∏ Crosshair √ßizgilerini g√∂ster
                const ann = fanChart.options.plugins.annotation.annotations;
                ann.crossX.display = true;
                ann.crossY.display = true;
                ann.crossX.xMin = ann.crossX.xMax = xValue;
                ann.crossY.yMin = ann.crossY.yMax = yValue;
                fanChart.update("none");
            });

            // üîπ Hover dolgu davranƒ±≈üƒ±
            fanChart.options.onHover = (event, activeElements) => {
                if (!activeElements.length) {
                    fanChart.data.datasets.forEach(ds => {
                        ds.fill = false;
                        ds.borderWidth = 3;
                    });
                    fanChart.update("none");
                    return;
                }

                const hoveredIndex = activeElements[0].datasetIndex;

                fanChart.data.datasets.forEach((ds, i) => {
                    ds.fill = i === hoveredIndex;
                    ds.borderWidth = i === hoveredIndex ? 3 : 1;
                });

                fanChart.update("none");
            };

            // üîπ Mouse √ßƒ±ktƒ±ƒüƒ±nda dolgularƒ± sƒ±fƒ±rla
            fanCanvas.addEventListener("mouseleave", () => {
                fanChart.data.datasets.forEach(ds => {
                    ds.fill = false;
                    ds.borderWidth = 1;
                });
                fanChart.update("none");
            });


        }

        // üîπ Working Point g√ºncelleme
        function updateWorkingPoint() {
            if (!fanChart) return;

            const x = parseFloat(document.getElementById("airFlowInput").value);
            const y = parseFloat(document.getElementById("pressureInput").value);
            const ann = fanChart.options.plugins.annotation.annotations;

            if (!isNaN(x) && !isNaN(y)) {
                ann.wpDot.display = true;
                ann.wpLabel.display = true;

                ann.wpDot.xValue = x;
                ann.wpDot.yValue = y;
                ann.wpLabel.xValue = x;
                ann.wpLabel.yValue = y;
                ann.wpLabel.content = [`Working Point (${x}, ${y})`];

                fanChart.update();
            } else {
                ann.wpDot.display = false;
                ann.wpLabel.display = false;
                fanChart.update();
            }
        }

        // üîπ ‚ÄúUygun Fanlarƒ± Bul‚Äù butonu
        document.getElementById("fanSelectorBtn").addEventListener("click", function (e) {
            e.preventDefault();

            const data = {
                applicationId: parseInt(document.getElementById("applicationSelect").value) || null,
                categoryId: parseInt(document.getElementById("categorySelect").value) || null,
                diameter: parseFloat(document.getElementById("diameterInput").value) || null,
                airFlow: parseFloat(document.getElementById("airFlowInput").value) || null,
                pressure: parseFloat(document.getElementById("pressureInput").value) || null,
                tolerancePercent: parseFloat(document.getElementById("toleranceInput").value) || 10,
                power: parseFloat(document.getElementById("powerInput").value) || null,
                voltage: parseFloat(document.getElementById("voltageInput").value) || null,
                frequency: parseFloat(document.getElementById("frequencySelect").value) || null,
                speed: parseFloat(document.getElementById("speedInput").value) || null,
                noiseLevel: parseFloat(document.getElementById("noiseInput").value) || null
            };

            const workingPoint = {
                x: parseFloat(document.getElementById("airFlowInput").value) || null,
                y: parseFloat(document.getElementById("pressureInput").value) || null
            };

            const resultsDiv = document.querySelector(".fan-results");
            resultsDiv.innerHTML = `
                                                <div class="text-center py-5">
                                                    <div class="spinner-border text-warning" role="status"></div>
                                                    <p class="text-muted mt-3 mb-0">Uygun fanlar aranƒ±yor...</p>
                                                </div>`;

            setTimeout(() => {
                fetch('@Url.Action("FilterProductsWithCurves", "FanSelector")', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                })
                    .then(r => { if (!r.ok) throw new Error("Sunucu hatasƒ±"); return r.json(); })
                    .then(res => {
                        resultsDiv.innerHTML = res.html;
                        drawFanChart(res.curves, workingPoint);
                    })
                    .catch(err => {
                        console.error(err);
                        resultsDiv.innerHTML = "<div class='alert alert-danger'>√úr√ºnler getirilirken hata olu≈ütu.</div>";
                    });
            }, 1000);
        });

        document.getElementById("airFlowInput").addEventListener("input", updateWorkingPoint);
        document.getElementById("pressureInput").addEventListener("input", updateWorkingPoint);
    </script>

}